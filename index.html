<script>
    let clientes = JSON.parse(localStorage.getItem('vehiculos')) || [];
    let vehiculosRetirados = JSON.parse(localStorage.getItem('vehiculosRetirados')) || [];

    const tarifaPorMinuto = 0.5; // Tarifa por minuto en Quetzales

    // Función para ingresar un vehículo
    function ingresarVehiculo() {
        const placa = document.getElementById('placa').value.trim();
        const marca = document.getElementById('marca').value.trim();

        console.log("Intentando ingresar vehículo...");
        console.log("Placa:", placa);
        console.log("Marca:", marca);

        if (!placa || !marca) {
            alert('Por favor, complete todos los campos.');
            return;
        }

        const horaIngreso = new Date();
        console.log("Hora de ingreso:", horaIngreso);

        clientes.push({ placa, marca, horaIngreso: horaIngreso.toISOString(), cronometroId: startCronometro(horaIngreso) });
        localStorage.setItem('vehiculos', JSON.stringify(clientes));
        actualizarTabla();
        document.getElementById('placa').value = '';
        document.getElementById('marca').value = '';
    }

    // Función para iniciar el cronómetro
    function startCronometro(horaIngreso) {
        const cronometroId = setInterval(() => {
            const tiempoTranscurrido = Math.floor((new Date() - horaIngreso) / 1000 / 60); // En minutos
            const fila = document.querySelector(`#cliente-${horaIngreso.getTime()}`);
            if (fila) {
                fila.querySelector(".tiempo").textContent = `${tiempoTranscurrido} min`;
            }
        }, 60000); // Actualizar cada minuto
        return cronometroId;
    }

    // Función para retirar un vehículo
    function retirarVehiculo(placa) {
        const vehiculo = clientes.find(v => v.placa === placa);
        const tarifa = calcularTarifa(new Date(vehiculo.horaIngreso));
        const fechaSalida = new Date().toLocaleString();

        vehiculosRetirados.push({ ...vehiculo, tarifaCobrada: tarifa, fechaSalida });
        clientes = clientes.filter(v => v.placa !== placa);

        localStorage.setItem('vehiculos', JSON.stringify(clientes));
        localStorage.setItem('vehiculosRetirados', JSON.stringify(vehiculosRetirados));

        actualizarTabla();
        actualizarTablaRetirados();
    }

    // Función para calcular la tarifa
    function calcularTarifa(horaIngreso) {
        const tiempoEnParqueo = Math.floor((new Date() - horaIngreso) / 1000 / 60); // En minutos
        return tiempoEnParqueo * tarifaPorMinuto;
    }

    // Función para visualizar la tarifa de un vehículo
    function visualizarTarifa(placa) {
        const vehiculo = clientes.find(v => v.placa === placa);
        const tarifa = calcularTarifa(new Date(vehiculo.horaIngreso));
        alert(`La tarifa actual para el vehículo con placa ${placa} es: Q${tarifa.toFixed(2)}`);
    }

    // Función para hacer el cierre del día
    function hacerCierre() {
        const clave = prompt("Ingrese la clave para realizar el cierre del día:");
        if (clave !== "Multicars") {
            alert("Clave incorrecta. No se puede realizar el cierre.");
            return;
        }

        if (vehiculosRetirados.length === 0) {
            alert("No hay registros de vehículos retirados.");
            return;
        }

        let total = 0;
        let ticketContent = "<h2>Resumen del Cierre</h2><table>";
        ticketContent += `
            <tr>
                <th>Fecha de Salida</th>
                <th>Placa</th>
                <th>Tarifa Cobrada</th>
            </tr>
        `;

        vehiculosRetirados.forEach(vehiculo => {
            total += vehiculo.tarifaCobrada;
            ticketContent += `
                <tr>
                    <td>${vehiculo.fechaSalida}</td>
                    <td>${vehiculo.placa}</td>
                    <td>Q${vehiculo.tarifaCobrada.toFixed(2)}</td>
                </tr>
            `;
        });

        ticketContent += `
            <tr>
                <td colspan="2"><strong>Total</strong></td>
                <td><strong>Q${total.toFixed(2)}</strong></td>
            </tr>
        </table>`;

        alert(`El total recaudado es Q${total.toFixed(2)}. Aquí están los detalles:\n\n${ticketContent}`);

        // Limpiar registros de vehículos retirados
        vehiculosRetirados = [];
        localStorage.setItem('vehiculosRetirados', JSON.stringify(vehiculosRetirados));
        actualizarTablaRetirados();
    }

    // Función para actualizar la tabla de vehículos en parqueo
    function actualizarTabla() {
        const tabla = document.getElementById('tablaClientes');
        tabla.innerHTML = `
            <tr>
                <th>Placa</th>
                <th>Marca</th>
                <th>Tiempo en Parqueo</th>
                <th>Tarifa</th>
                <th>Acciones</th>
            </tr>
        `;
        clientes.forEach((vehiculo) => {
            const fechaIngreso = new Date(vehiculo.horaIngreso);
            const tiempoEnParqueo = Math.floor((new Date() - fechaIngreso) / 1000 / 60); // En minutos
            const fila = document.createElement('tr');
            fila.id = `cliente-${fechaIngreso.getTime()}`;
            fila.innerHTML = `
                <td>${vehiculo.placa}</td>
                <td>${vehiculo.marca}</td>
                <td class="tiempo">${tiempoEnParqueo} min</td>
                <td>Q${calcularTarifa(fechaIngreso).toFixed(2)}</td>
                <td>
                    <button onclick="retirarVehiculo('${vehiculo.placa}')">Retirar</button>
                    <button onclick="visualizarTarifa('${vehiculo.placa}')">Ver Tarifa</button>
                </td>
            `;
            tabla.appendChild(fila);
        });
    }

    // Función para actualizar la tabla de vehículos retirados
    function actualizarTablaRetirados() {
        const tabla = document.getElementById('tablaVehiculosRetirados');
        tabla.innerHTML = `
            <tr>
                <th>Placa</th>
                <th>Marca</th>
                <th>Tarifa Cobrada</th>
                <th>Fecha de Salida</th>
                <th>Acciones</th>
            </tr>
        `;
        vehiculosRetirados.forEach((vehiculo) => {
            const fila = document.createElement('tr');
            fila.innerHTML = `
                <td>${vehiculo.placa}</td>
                <td>${vehiculo.marca}</td>
                <td>Q${vehiculo.tarifaCobrada.toFixed(2)}</td>
                <td>${vehiculo.fechaSalida}</td>
                <td><button onclick="imprimirVenta('${vehiculo.placa}', ${vehiculo.tarifaCobrada})">Imprimir</button></td>
            `;
            tabla.appendChild(fila);
        });
    }

    // Inicializar tablas al cargar la página
    actualizarTabla();
    actualizarTablaRetirados();
</script>
